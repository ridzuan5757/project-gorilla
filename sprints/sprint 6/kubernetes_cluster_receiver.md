# Kubernetes Cluster Receiver

The Kubernetes Cluster Receiver that will be built into OpenTelemetry Collector is designed to collect metrics and logs from Kubernetes cluster. This receiver will collects metrics and entity events about the cluster as a whole using the `k8s` API server. This receiver will be used to
monitor:
- Pod phases
- Node conditions
- Other cluster-wide information

# Motivation
- Collect metrics and logs from various components of the `K8S` cluster.
- Export collected data to the visualisation component of the Proactive Monitoring infrastructure i.e. OpenSearch Dashboard.

# Specification

Since the receiver gathers telemetry for the cluster as a whole, ***only one
instance of the receiver is needed across the cluster in order to collect all
the data.***

There are different method of authentication, but typically `ServiceAccount` is
used. The `ServiceAccount` also require permissions to pull data from the
`k8s` API server using the following `ClusterRole` permission.

| **API Groups** | **Resources**                  | **Verbs** |
|----------------|--------------------------------|-----------|
| `""`           | `events`                       | `get`     |
|                | `namespaces`                   | `list`    |
|                | `namespaces/status`            | `watch`   |
|                | `nodes`                        |           |
|                | `nodes/spec`                   |           |
|                | `pods`                         |           |
|                | `pods/status`                  |           |
|                | `replicationcontroller`        |           |
|                | `replicationcontroller/status` |           |
|                | `resourcequotas`               |           |
|                | `services`                     |           |
| `apps`         | `daemonsets`                   | `get`     |
|                | `deployments`                  | `list`    |
|                | `replicasets`                  | `watch`   |
| `batch`        | `jobs`                         | `get`     |
|                | `cronjobs`                     | `list`    |
|                |                                | `watch`   |
| `autoscaling`  | `horizontalpodautoscalers`     | `get`     |
|                |                                | `list`    |
|                |                                | `watch`   |
 
The metrics that will be emitted by this receiver shall obey the following specification.

| **Metric**                               | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | **Enabled** |
|------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------|
| `k8s.container.cpu_request`              | Resource   requested for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `true`      |
| `k8s.container.cpu_limit`                | Maximum resource limit set for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.container.memory_request`           | Resource requested for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `true`      |
| `k8s.container.memory_limit`             | Maximum resource limit set for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.container.storage_request`          | Resource requested for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `true`      |
| `k8s.container.storage_limit`            | Maximum resource limit set for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.container.ephemeralstorage_request` | Resource requested for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `true`      |
| `k8s.container.ephemeralstorage_limit`   | Maximum resource limit set for the container.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.container.restarts`                 | How many times the container has restarted in the recent past.   This value is pulled directly from the K8s API and the value can go   indefinitely high and be reset to 0 at any time depending on how your kubelet   is configured to prune dead containers. It is best to not depend too much on   the exact value but rather look at it as either == 0, in which case you can   conclude there were no restarts in the recent past, or > 0, in which case   you can conclude there were restarts in the recent past, and not try and   analyze the value beyond that. | `true`      |
| `k8s.container.ready`                    | Whether a container has passed its readiness probe                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `true`      |
| `k8s.pod.phase`                          | Current phase of the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `true`      |
| `k8s.pod.status_reason`                  | Current status reason of the pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`      |
| `k8s.deployment.desired`                 | Number of desired pods in this deployment                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `true`      |
| `k8s.deployment.available`               | Total number of available pods (ready for at least   minReadySeconds) targeted by this deployment                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`      |
| `k8s.cronjob.active_jobs`                | The number of actively running jobs for a cronjob                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `false`     |
| `k8s.daemonset.current_scheduled_nodes`  | Number of nodes that are running at least 1 daemon pod and are   supposed to run the daemon pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `true`      |
| `k8s.daemonset.desired_scheduled_nodes`  | Number of nodes that should be running the daemon pod (including   nodes currently running the daemon pod)                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `true`      |
| `k8s.daemonset.misscheduled_nodes`       | Number of nodes that are running the daemon pod, but are not   supposed to run the daemon pod                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.daemonset.ready_nodes`              | Number of nodes that should be running the daemon pod and have   one or more of the daemon pod running and ready                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`      |
| `k8s.hpa.max_replicas`                   | Maximum number of replicas to which the autoscaler can scale up.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`      |
| `k8s.hpa.min_replicas`                   | Minimum number of replicas to which the autoscaler can scale up.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | `true`      |
| `k8s.hpa.current_replicas`               | Current number of pod replicas managed by this autoscaler.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `true`      |
| `k8s.hpa.desired_replicas`               | Desired number of pod replicas managed by this autoscaler.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `true`      |
| `k8s.job.active_pods`                    | The number of actively running pods for a job                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `false`     |
| `k8s.job.desired_successful_pods`        | The desired number of successfully finished pods the job should   be run with                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `false`     |
| `k8s.job.failed_pods`                    | The number of pods which reached phase Failed for a job                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`     |
| `k8s.job.max_parallel_pods`              | The max desired number of pods the job should run at any given   time                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `false`     |
| `k8s.job.successful_pods`                | The number of pods which reached phase Succeeded for a job                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `false`     |
| `k8s.namespace.phase`                    | The current phase of namespaces                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | `true`      |
| `k8s.replicaset.desired`                 | Number of desired pods in this replicaset                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `true`      |
| `k8s.replicaset.available`               | Total number of available pods (ready for at least   minReadySeconds) targeted by this replicaset                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `true`      |
| `k8s.replication_controller.desired`     | Number of desired pods in this replication_controller                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `true`      |
| `k8s.replication_controller.available`   | Total number of available pods (ready for at least   minReadySeconds) targeted by this replication_controller                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `true`      |
| `k8s.resource_quota.hard_limit`          | The upper limit for a particular resource in a specific   namespace. Will only be sent if a quota is specified. CPU requests/limits   will be sent as millicores                                                                                                                                                                                                                                                                                                                                                                                                          | `true`      |
| `k8s.resource_quota.used`                | The usage for a particular resource in a specific namespace.   Will only be sent if a quota is specified. CPU requests/limits will be sent   as millicores                                                                                                                                                                                                                                                                                                                                                                                                                | `true`      |
| `k8s.statefulset.desired_pods`           | Number of desired pods in the stateful set (the `spec.replicas`   field)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | `false`     |
| `k8s.statefulset.ready_pods`             | Number of pods created by the stateful set that have the `Ready`   condition                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `false`     |
| `k8s.statefulset.current_pods`           | The number of pods created by the StatefulSet controller from   the StatefulSet version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `false`     |
| `k8s.statefulset.updated_pods`           | Number of pods created by the StatefulSet controller from the   StatefulSet version                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | `false`     |
| `openshift.clusterquota.limit`           | The configured upper limit for a particular resource.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `false`     |
| `openshift.clusterquota.used`            | The usage for a particular resource with a configured limit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `false`     |
| `openshift.appliedclusterquota.limit`    | The upper limit for a particular resource in a specific   namespace.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `false`     |
| `openshift.appliedclusterquota.used`     | The usage for a particular resource in a specific namespace.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `false`     |
| `k8s.node.condition`                     | The condition of a particular Node                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `false`     |


# Tasks:
- Implement Kubernetes Cluster Receiver in OpenTelemetry Deployment Gateway.
- Configure `ClusterRole` for `k8s_cluster` receiver.
